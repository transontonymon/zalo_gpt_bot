const express = require('express');
const bodyParser = require('body-parser');
const axios = require('axios');

const app = express();
const PORT = process.env.PORT || 3000;

app.use(bodyParser.json());

// Route chính để nhận dữ liệu từ Zalo
app.post('/webhook', async (req, res) => {
    const { user_id, message } = req.body;

    // Gọi GPT API để xử lý tin nhắn
    const gptResponse = await axios.post('https://api.openai.com/v1/chat/completions', {
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: message }],
    }, {
        headers: {
            'Authorization': `Bearer ${process.env.GPT_API_KEY}`,
            'Content-Type': 'application/json',
        },
    });

    const reply = gptResponse.data.choices[0].message.content;

    // Gửi phản hồi lại cho người dùng qua Zalo API
    await axios.post('https://openapi.zalo.me/v2.0/oa/message', {
        recipient: { user_id },
        message: { text: reply },
    }, {
        headers: {
            'access_token': process.env.ZALO_OA_ACCESS_TOKEN,
            'Content-Type': 'application/json',
        },
    });

    // Lưu thông tin vào Google Sheet (tùy chọn)
    // Anh có thể sử dụng Google Sheets API hoặc Google Apps Script để thực hiện việc này

    res.status(200).send('OK');
});

app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
